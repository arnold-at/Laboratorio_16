<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reconocimiento Facial - Arnold</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
        }
        
        #resultado {
            font-weight: bold;
            font-size: 6rem;
            text-align: center;
            margin-top: 30px;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }
        
        .arnold { 
            color: #00ff00;
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        
        .desconocido { 
            color: #ff0000;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00; }
            to { text-shadow: 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00; }
        }
        
        #confianza {
            text-align: center;
            font-size: 2.5rem;
            color: #aaa;
            margin-top: 20px;
        }

        .status {
            padding: 20px;
            margin: 30px 0;
            border-radius: 15px;
            text-align: center;
            background: rgba(255,255,255,0.05);
            border: 2px solid #333;
            backdrop-filter: blur(10px);
        }

        .status.loading { border-color: #ffaa00; color: #ffaa00; }
        .status.ready { border-color: #00ff00; color: #00ff00; }
        .status.error { border-color: #ff0000; color: #ff0000; }

        canvas#canvas {
            border: 4px solid #00ff00;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0,255,0,0.3);
        }

        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 15px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }

        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102,126,234,0.6);
        }

        .container-main {
            background: rgba(255,255,255,0.03);
            border-radius: 30px;
            padding: 40px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <main>
        <div class="px-4 py-4 text-center">
            <h1 class="display-3 fw-bold">üîê Reconocimiento Facial</h1>
            <p class="lead fs-4">Sistema de Identificaci√≥n Biom√©trica</p>
        </div>

        <div class="container">
            <div id="status" class="status loading">‚è≥ Cargando modelo de IA...</div>
            
            <div class="container-main">
                <div class="row">
                    <div class="col-12 col-md-8 offset-md-2 text-center">
                        <video id="video" playsinline autoplay style="width: 1px;"></video>
                        
                        <div class="mb-4">
                            <button class="btn btn-custom btn-lg" id="btnIniciar" onclick="iniciarCamara()" disabled>
                                üì∑ Iniciar C√°mara
                            </button>
                            
                            <button class="btn btn-custom btn-lg" id="btnCambiar" onclick="cambiarCamara()" disabled>
                                üîÑ Cambiar C√°mara
                            </button>
                        </div>
                        
                        <canvas id="canvas" width="400" height="400" style="max-width: 100%;"></canvas>
                        <canvas id="otrocanvas" width="100" height="100" style="display: none"></canvas>
                        
                        <div id="resultado">Esperando...</div>
                        <div id="confianza">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

    <script>
        const TAMANO = 400;
        
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let otrocanvas = document.getElementById("otrocanvas");
        let ctx = canvas.getContext("2d");
        let currentStream = null;
        let facingMode = "user";
        let modelo = null;
        let detectando = false;

        function actualizarEstado(mensaje, tipo = 'loading') {
            const status = document.getElementById('status');
            status.textContent = mensaje;
            status.className = `status ${tipo}`;
        }

        (async () => {
            try {
                actualizarEstado('‚è≥ Cargando modelo...', 'loading');
                modelo = await tf.loadLayersModel("model.json");
                actualizarEstado('‚úÖ Modelo listo. Presiona "Iniciar C√°mara"', 'ready');
                document.getElementById('btnIniciar').disabled = false;
            } catch (error) {
                actualizarEstado('‚ùå Error: No se encontr√≥ model.json', 'error');
                alert('Aseg√∫rate de tener model.json y los archivos .bin en la misma carpeta');
            }
        })();

        async function iniciarCamara() {
            if (!modelo) return;

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        facingMode: facingMode,
                        width: { ideal: TAMANO },
                        height: { ideal: TAMANO }
                    }
                });
                
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    actualizarEstado('‚úÖ Detectando en tiempo real...', 'ready');
                    document.getElementById('btnIniciar').disabled = true;
                    document.getElementById('btnCambiar').disabled = false;
                    detectando = true;
                    procesarCamara();
                    predecir();
                };
                
            } catch (error) {
                actualizarEstado('‚ùå Error al acceder a la c√°mara', 'error');
                if (error.name === 'NotAllowedError') {
                    alert('‚ö†Ô∏è Permiso denegado\n\nPara permitir la c√°mara:\n1. Click en el üîí en la barra de direcciones\n2. Permitir "C√°mara"\n3. Recargar la p√°gina');
                } else {
                    alert('Error: ' + error.message);
                }
            }
        }

        function cambiarCamara() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            facingMode = facingMode === "user" ? "environment" : "user";
            detectando = false;
            setTimeout(iniciarCamara, 300);
        }

        function procesarCamara() {
            if (detectando) {
                ctx.drawImage(video, 0, 0, TAMANO, TAMANO, 0, 0, TAMANO, TAMANO);
                requestAnimationFrame(procesarCamara);
            }
        }

        async function predecir() {
            if (!detectando || !modelo) return;

            try {
                resample_single(canvas, 100, 100, otrocanvas);

                const ctx2 = otrocanvas.getContext("2d");
                const imgData = ctx2.getImageData(0, 0, 100, 100);

                let arr = [];
                let arr100 = [];

                // Convertir directamente usando TensorFlow.js
                const tensor = tf.browser.fromPixels(otrocanvas)
                 .toFloat()
                 .div(255.0)
                 .expandDims(0);
                 
                const resultado = modelo.predict(tensor).dataSync();
                tensor.dispose();

                const valor = resultado[0];
                const clase = valor > 0.5 ? "Arnold" : "Desconocido";
                const confianza = valor > 0.5 ? valor * 100 : (1 - valor) * 100;

                document.getElementById('resultado').textContent = clase;
                document.getElementById('resultado').className = clase.toLowerCase();
                document.getElementById('confianza').textContent = `${confianza.toFixed(1)}%`;
                
            } catch (error) {
                console.error('Error en predicci√≥n:', error);
            }

            setTimeout(predecir, 150);
        }

        function resample_single(canvas, width, height, resize_canvas) {
            const width_source = canvas.width;
            const height_source = canvas.height;
            width = Math.round(width);
            height = Math.round(height);

            const ratio_w = width_source / width;
            const ratio_h = height_source / height;
            const ratio_w_half = Math.ceil(ratio_w / 2);
            const ratio_h_half = Math.ceil(ratio_h / 2);

            const ctx = canvas.getContext("2d");
            const ctx2 = resize_canvas.getContext("2d");
            const img = ctx.getImageData(0, 0, width_source, height_source);
            const img2 = ctx2.createImageData(width, height);
            const data = img.data;
            const data2 = img2.data;

            for (let j = 0; j < height; j++) {
                for (let i = 0; i < width; i++) {
                    const x2 = (i + j * width) * 4;
                    let weight = 0;
                    let weights = 0;
                    let weights_alpha = 0;
                    let gx_r = 0;
                    let gx_g = 0;
                    let gx_b = 0;
                    let gx_a = 0;
                    const center_y = (j + 0.5) * ratio_h;
                    const yy_start = Math.floor(j * ratio_h);
                    const yy_stop = Math.ceil((j + 1) * ratio_h);
                    for (let yy = yy_start; yy < yy_stop; yy++) {
                        const dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
                        const center_x = (i + 0.5) * ratio_w;
                        const w0 = dy * dy;
                        const xx_start = Math.floor(i * ratio_w);
                        const xx_stop = Math.ceil((i + 1) * ratio_w);
                        for (let xx = xx_start; xx < xx_stop; xx++) {
                            const dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                            const w = Math.sqrt(w0 + dx * dx);
                            if (w >= 1) {
                                continue;
                            }
                            weight = 2 * w * w * w - 3 * w * w + 1;
                            const pos_x = 4 * (xx + yy * width_source);
                            gx_a += weight * data[pos_x + 3];
                            weights_alpha += weight;
                            if (data[pos_x + 3] < 255)
                                weight = weight * data[pos_x + 3] / 250;
                            gx_r += weight * data[pos_x];
                            gx_g += weight * data[pos_x + 1];
                            gx_b += weight * data[pos_x + 2];
                            weights += weight;
                        }
                    }
                    data2[x2] = gx_r / weights;
                    data2[x2 + 1] = gx_g / weights;
                    data2[x2 + 2] = gx_b / weights;
                    data2[x2 + 3] = gx_a / weights_alpha;
                }
            }

            ctx2.putImageData(img2, 0, 0);
        }
    </script>
</body>
</html>